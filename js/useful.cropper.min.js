/*
	Source:
	van Creij, Maurice (2012). "useful.cropper.js: A simple image cropper", version 20130510, http://www.woollymittens.nl/.

	License:
	This work is licensed under a Creative Commons Attribution 3.0 Unported License.

	Prerequisites:
	<script src="./js/useful.js"></script>
	<!--[if IE]>
		<script src="./js/html5.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<![endif]-->
*/(function(e){"use strict";var t={};t={cropper:null,names:["tl","tc","tr","ml","mr","bl","bc","br"],setup:function(e,n){n.parent=e;n.image=n.parent.getElementsByTagName("img")[0];n.output=n.parent.getElementsByTagName("input");n.onchange=n.onchange||function(){};n.delay=n.delay||1e3;n.minimum=n.minimum||.2;n.crop=n.crop||[.1,.1,.9,.9];n.url=n.image.src;n.offset=n.offset||4;t.busy.build(n);t.indicator.build(n);t.toolbar.build(n);t.start(n)},start:function(e){if(e.image.offsetWidth>0&&e.image.offsetHeight>0){t.update(e);t.preset(e)}else e.image.onload=function(){t.update(e);t.preset(e)}},preset:function(t){var n,r,i,s;if(t.image.offsetWidth){n=e.urls.load(t.url);if(n.left>0||n.top>0||n.right<1||n.bottom<1){n.left=n.left||0;n.top=n.top||0;n.right=n.right||1;n.bottom=n.bottom||1;t.crop=[n.left,n.top,n.right,n.bottom];r=t.image.offsetWidth;i=t.image.offsetHeight;s=i/(t.crop[3]-t.crop[1])/(r/(t.crop[2]-t.crop[0]));r>i?i=r*s:r=i/s;r=Math.round(r);i=Math.round(i);t.image.style.maxWidth=r+"px";t.image.style.maxHeight=i+"px";t.url=e.urls.replace(t.url,"width",r);t.url=e.urls.replace(t.url,"height",i);t.url=e.urls.replace(t.url,"left",0);t.url=e.urls.replace(t.url,"top",0);t.url=e.urls.replace(t.url,"right",1);t.url=e.urls.replace(t.url,"bottom",1);t.parent.style.width=r+"px";t.parent.style.height=i+"px";t.image.style.marginTop=Math.round((t.parent.offsetHeight-t.image.offsetHeight-t.offset)/2)+"px";t.applyButton.disabled=!0;t.parent.className=t.parent.className.replace(" cr-disabled","")+" cr-disabled"}}},update:function(e){e.output[0].value=e.crop[0];e.output[1].value=e.crop[1];e.output[2].value=e.crop[2];e.output[3].value=e.crop[3];t.indicator.update(e);clearTimeout(t.timeout);t.timeout=setTimeout(function(){e.onchange(e.output[0])},e.delay)},busy:{build:function(e){e.busy=document.createElement("span");e.busy.className="cr-busy";e.busy.innerHTML="Please wait...";e.busy.style.visibility="hidden";e.parent.appendChild(e.busy)},show:function(e){e.busy.style.visibility="visible"},hide:function(e){e.busy.style.visibility="hidden"}},indicator:{build:function(n){n.overlay=document.createElement("span");n.overlay.className="cr-overlay";n.overlay.style.background="url("+n.image.src+")";t.indicator.handles.build(n);n.parent.appendChild(n.overlay);n.moving=!1;e.interaction.watch(n.overlay,{start:function(){n.moving=!0},end:function(){n.moving=!1},move:function(e){n.sizing||t.indicator.move(n,e)}})},update:function(e){var t,n,r,i;e.width=e.image.offsetWidth;e.height=e.image.offsetHeight;t=e.crop[0]*e.width;n=e.crop[1]*e.height;r=e.width-e.crop[2]*e.width;i=e.height-e.crop[3]*e.height;e.overlay.style.left=t+"px";e.overlay.style.top=n+"px";e.overlay.style.right=r+"px";e.overlay.style.bottom=i+"px";e.overlay.style.backgroundPosition="-"+t+"px -"+n+"px"},move:function(e,n){var r,i,s,o,u,a;r=(n[0].move.x-n[0].start.x)/e.width;i=(n[0].move.y-n[0].start.y)/e.height;s=e.crop[0]+r;o=e.crop[1]+i;u=e.crop[2]+r;a=e.crop[3]+i;if(s>=0&&o>=0&&u<=1&&a<=1&&s<u&&o<a){e.crop[0]=s;e.crop[1]=o;e.crop[2]=u;e.crop[3]=a}n[0].start.x=n[0].move.x;n[0].start.y=n[0].move.y;t.update(e)},handles:{build:function(e){var n,r,i;e.handles={};for(n=0,r=t.names.length;n<r;n+=1){i=t.names[n];e.handles[i]=document.createElement("span");e.handles[i].className="cr-"+i;e.overlay.appendChild(e.handles[i]);e.sizing=!1;t.indicator.handles.move(e,i)}},move:function(n,r){e.interaction.watch(n.handles[r],{start:function(){n.sizing=!0},end:function(){n.sizing=!1},move:function(e){switch(r){case"tl":t.indicator.handles.left(n,e);t.indicator.handles.top(n,e);break;case"tc":t.indicator.handles.top(n,e);break;case"tr":t.indicator.handles.right(n,e);t.indicator.handles.top(n,e);break;case"ml":t.indicator.handles.left(n,e);break;case"mr":t.indicator.handles.right(n,e);break;case"bl":t.indicator.handles.left(n,e);t.indicator.handles.bottom(n,e);break;case"bc":t.indicator.handles.bottom(n,e);break;case"br":t.indicator.handles.right(n,e);t.indicator.handles.bottom(n,e)}return!1}})},left:function(e,n){var r,i,s,o;r=(n[0].move.x-n[0].start.x)/e.width;i=e.crop[0]+r;s=e.crop[2]+r;o=e.crop[2]-e.minimum;i>=0&&i<o&&(e.crop[0]=i);n[0].start.x=n[0].move.x;t.update(e)},top:function(e,n){var r,i,s,o;r=(n[0].move.y-n[0].start.y)/e.height;i=e.crop[1]+r;s=e.crop[3]+r;o=e.crop[3]-e.minimum;i>=0&&i<o&&(e.crop[1]=i);n[0].start.y=n[0].move.y;t.update(e)},right:function(e,n){var r,i,s,o;r=(n[0].move.x-n[0].start.x)/e.width;i=e.crop[0]+r;s=e.crop[2]+r;o=e.crop[0]+e.minimum;s<=1&&s>o&&(e.crop[2]=s);n[0].start.x=n[0].move.x;t.update(e)},bottom:function(e,n){var r,i,s,o;r=(n[0].move.y-n[0].start.y)/e.height;i=e.crop[1]+r;s=e.crop[3]+r;o=e.crop[1]+e.minimum;s<=1&&s>o&&(e.crop[3]=s);n[0].start.y=n[0].move.y;t.update(e)}}},toolbar:{build:function(e){e.toolbar=document.createElement("figcaption");e.applyButton=document.createElement("button");e.applyButton.setAttribute("type","button");e.applyButton.className="cr-apply button";e.applyButton.innerHTML="Apply";e.toolbar.appendChild(e.applyButton);e.applyButton.onclick=function(){t.toolbar.apply(e)};e.resetButton=document.createElement("button");e.resetButton.setAttribute("type","button");e.resetButton.className="cr-reset button";e.resetButton.innerHTML="Reset";e.toolbar.appendChild(e.resetButton);e.resetButton.onclick=function(){t.toolbar.reset(e)};e.parent.appendChild(e.toolbar)},apply:function(n){var r,i,s;i=n.overlay.offsetWidth;s=n.overlay.offsetHeight;if(i>s){s=n.image.offsetWidth/i*n.overlay.offsetHeight;i=n.image.offsetWidth}else{i=n.image.offsetHeight/s*n.overlay.offsetWidth;s=n.image.offsetHeight}n.parent.style.width=n.image.offsetWidth+"px";n.parent.style.height=n.image.offsetHeight+"px";t.busy.show(n);n.image.onload=function(){n.image.style.marginTop=Math.round((n.parent.offsetHeight-n.image.offsetHeight-n.offset)/2)+"px";t.busy.hide(n)};i=Math.round(i);s=Math.round(s);r=n.image.src;r=e.urls.replace(r,"width",i);r=e.urls.replace(r,"height",s);r=e.urls.replace(r,"left",n.crop[0]);r=e.urls.replace(r,"top",n.crop[1]);r=e.urls.replace(r,"right",n.crop[2]);r=e.urls.replace(r,"bottom",n.crop[3]);n.image.src=r;n.applyButton.disabled=!0;n.parent.className=n.parent.className.replace(" cr-disabled","")+" cr-disabled";return!1},reset:function(e){t.busy.show(e);e.image.onload=function(){e.image.style.marginTop=0;t.update(e);e.applyButton.disabled=!1;e.parent.className=e.parent.className.replace(" cr-disabled","");t.busy.hide(e)};e.image.src=e.url;e.overlay.style.backgroundImage="url("+e.url+")";return!1}}};e.events=e.events||{};e.events.add=function(e,t,n){t=navigator.userAgent.match(/Firefox/i)&&t.match(/mousewheel/i)?"DOMMouseScroll":t;"addEventListener"in e?e.addEventListener(t,n,!1):"attachEvent"in e?e.attachEvent("on"+t,function(e){n(e)}):e["on"+t]=n};e.events.cancel=function(e){e&&(e.preventDefault?e.preventDefault():e.preventManipulation?e.preventManipulation():e.returnValue=!1)};e.models=e.models||{};e.models.clone=function(e){var t,n;if(typeof Object.create!="undefined")t=Object.create(e);else{n=function(){};n.prototype=e;t=new n}return t};e.css=e.css||{};e.css.select=function(t,n){var r,i,s;n=n||document;t=typeof t=="string"?{rule:t,parent:n}:t;t.parent=t.parent||document;t.data=t.data||{};s=typeof document.querySelectorAll!="undefined"?t.parent.querySelectorAll(t.rule):typeof jQuery!="undefined"?jQuery(t.parent).find(t.rule).get():[];if(typeof t.handler=="undefined")return s;for(r=0,i=s.length;r<i;r+=1)t.handler(s[r],e.models.clone(t.data))};e.interaction=e.interaction||{};e.interaction.watch=function(t,n,r){"ontouchstart"in window||"onmsgesturechange"in window?e.interaction.touch(t,n,r):e.interaction.mouse(t,n,r)};e.interaction.mouse=function(t,n,r){var i,s,o,u;n=n||{};n.wheel=n.wheel||function(){};n.start=n.start||function(){};n.move=n.move||function(){};n.end=n.end||function(){};r=r||{};i=function(t){r.wheel={y:window.event?window.event.wheelDelta/120:-t.detail/3};n.wheel(r);e.events.cancel(t)};t.onmousewheel=i;navigator.userAgent.match(/firefox/gi)&&t.addEventListener("DOMMouseScroll",i,!1);s=function(t){t=t||window.event;r[0]={};r[0].start={x:t.pageX||t.x,y:t.pageY||t.y};n.start(r);e.events.cancel(t)};e.events.add(t,"mousedown",s);o=function(t){t=t||window.event;if(r[0]&&r[0].start){r[0].move={x:t.pageX||t.x,y:t.pageY||t.y};n.move(r)}e.events.cancel(t)};e.events.add(document,"mousemove",o);u=function(t){t=t||window.event;r[0]&&(r[0].end={x:t.pageX||t.x,y:t.pageY||t.y});n.end(r);r[0]={};e.events.cancel(t)};e.events.add(document,"mouseup",u)};e.interaction.touch=function(t,n,r){var i,s,o;n=n||{};n.start=n.start||function(){};n.move=n.move||function(){};n.end=n.end||function(){};r=r||{};i=function(e){var t,i,s,o;s=e.touches||[e];for(t=0,i=s.length;t<i;t+=1){o=e.pointerId||t;r[o]={};r[o].start={x:s[t].pageX,y:s[t].pageY};n.start(r)}};t.ontouchstart=i;t.onmspointerdown=i;s=function(t){var i,s,o,u;o=t.touches||[t];for(i=0,s=o.length;i<s;i+=1){u=t.pointerId||i;if(r[u]&&r[u].start){r[u].move={x:o[i].pageX,y:o[i].pageY};n.move(r)}}e.events.cancel(t)};t.ontouchmove=s;t.onmspointermove=s;o=function(e){var t,i,s,o;t=e.touches||[e];for(i=0,s=t.length;i<s;i+=1){if(r[o]&&r[o].start){r[o].end={x:t[i].pageX,y:t[i].pageY};n.end(r)}r[o]={}}};t.ontouchend=o;t.onmspointerup=o};e.interaction.gestures=function(e,t,n){var r,i,s;t=t||{};t.start=t.start||function(){};t.move=t.move||function(){};t.end=t.end||function(){};n=n||{};r=function(e){n[0]={};n[0].start={rotation:e.rotation,scale:e.scale};t.start(n)};e.ongesturestart=r;e.onmsgesturestart=r;i=function(e){if(n[0]&&n[0].start){n[0].move={rotation:e.rotation,scale:e.scale};t.move(n)}};e.ongesturechange=i;e.onmsgesturechange=i;s=function(e){n[0].end={rotation:e.rotation,scale:e.scale};t.end(n);n[0]={}};e.ongestureend=s;e.onmsmsgestureend=s};e.urls=e.urls||{};e.urls.load=function(e){var t,n,r=[],i={},s,o;r=e.split("#")[0].replace("?","&").split("&");for(t=1,n=r.length;t<n;t+=1){s=r[t].split("=");o=parseFloat(s[1]);i[s[0]]=isNaN(o)?s[1]:o}return i};e.urls.save=function(e,t){var n;e=e.split("?")[0].split("#")[0];for(n in t)t.hasOwnProperty(n)&&(e+="&"+n+"="+t[n]);return e.replace("&","?")};e.urls.replace=function(t,n,r){var i,s,o;s=new RegExp(n+"=","gi");if(s.test(t)){i=t.split("#")[0].split(n+"=")[1].split("&")[0];return t.replace(n+"="+i,n+"="+r)}o=e.urls.load(t);o[n]=r;return e.urls.save(t,o)};e.cropper={};e.cropper.setup=t.setup})(window.useful=window.useful||{});